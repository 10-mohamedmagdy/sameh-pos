product 
from PyQt5.QtWidgets import QWidget, QLabel, QPushButton, QVBoxLayout, QMessageBox, QInputDialog, QTableWidget, QTableWidgetItem, QDialog
from PyQt5.QtCore import Qt
from PyQt5.QtGui import QImage, QPixmap
import qrcode  # Make sure you have the qrcode library installed
import io
import os
from database import db  # Assuming db is your database instance


class ProductManagementWindow(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª")
        self.setGeometry(150, 150, 600, 400)  # Adjust size if needed
        self.initUI()

    def initUI(self):
        layout = QVBoxLayout()

        title = QLabel("ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", self)
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        title.setAlignment(Qt.AlignCenter)
        layout.addWidget(title)

        # Control buttons in the product management window
        buttons = {
            "Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª": self.show_all_products,
            "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯": self.add_product,
            "ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬": self.edit_product,
            "Ø­Ø°Ù Ù…Ù†ØªØ¬": self.delete_product,
            "Ø¥Ù†Ø´Ø§Ø¡ QR ÙƒÙˆØ¯": self.generate_qr,
            "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©": self.close
        }

        for label, func in buttons.items():
            btn = QPushButton(label, self)
            btn.clicked.connect(func)
            layout.addWidget(btn)

        # Adding a table to display products
        self.product_table = QTableWidget(self)
        self.product_table.setColumnCount(4)
        self.product_table.setHorizontalHeaderLabels(["Ø§Ù„ÙƒÙˆØ¯", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ø³Ø¹Ø±", "Ø§Ù„ÙƒÙ…ÙŠØ©"])

        # Add table to layout
        layout.addWidget(self.product_table)
        
        self.setLayout(layout)

    def show_all_products(self):
        # Fetch all products from the database
        products = db.get_all_products()

        # Clear current table data
        self.product_table.setRowCount(0)

        # Insert products into the table
        for row, product in enumerate(products):
            self.product_table.insertRow(row)
            for col, value in enumerate(product):
                self.product_table.setItem(row, col, QTableWidgetItem(str(value)))

    def add_product(self):
        # Add a new product
        code, ok1 = QInputDialog.getText(self, "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬", "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:")
        if not ok1 or code in [prod[0] for prod in db.get_all_products()]:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­.")
            return

        name, ok2 = QInputDialog.getText(self, "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬", "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:")
        if not ok2:
            return

        price, ok3 = QInputDialog.getDouble(self, "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬", "Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬:", decimals=2)
        if not ok3:
            return

        quantity, ok4 = QInputDialog.getInt(self, "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬", "Ø§Ù„ÙƒÙ…ÙŠØ©:")
        if not ok4:
            return

        # Add product to the database
        db.add_product(code, name, price, quantity)
        QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!")
        
        # Refresh table to show new product
        self.show_all_products()

    def edit_product(self):
        # Edit a product
        code, ok = QInputDialog.getText(self, "ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬", "Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:")
        if ok and code:
            product = db.get_product(code)
            if product:
                name, _ = QInputDialog.getText(self, "ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù…", "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:", text=product[1])
                price, _ = QInputDialog.getDouble(self, "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±", "Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬:", value=product[2])
                quantity, _ = QInputDialog.getInt(self, "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©", "Ø§Ù„ÙƒÙ…ÙŠØ©:", value=product[3])

                # Update the product in the database
                db.update_product(code, name, price, quantity)  # Fixed issue here
                QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.")
                
                # Refresh table to show updated product
                self.show_all_products()
            else:
                QMessageBox.warning(self, "Ø®Ø·Ø£", "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")
        else:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± ØµØ§Ù„Ø­.")

    def delete_product(self):
        # Delete a product
        code, ok = QInputDialog.getText(self, "Ø­Ø°Ù Ù…Ù†ØªØ¬", "Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:")
        if ok and code:
            product = db.get_product(code)
            if product:
                db.cursor.execute("DELETE FROM products WHERE code = ?", (code,))
                db.conn.commit()
                QMessageBox.information(self, "ØªÙ…", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.")
                
                # Refresh table after deletion
                self.show_all_products()
            else:
                QMessageBox.warning(self, "Ø®Ø·Ø£", "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")
        else:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± ØµØ§Ù„Ø­.")

    def generate_qr(self):
        # Generate QR code for product
        code, ok = QInputDialog.getText(self, "Ø¥Ù†Ø´Ø§Ø¡ QR ÙƒÙˆØ¯", "Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬:")
        if ok and code:
            product = db.get_product(code)
            if product:
                qr_data = f"ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬: {product[0]}\nØ§Ù„Ø§Ø³Ù…: {product[1]}\nØ§Ù„Ø³Ø¹Ø±: {product[2]}\nØ§Ù„ÙƒÙ…ÙŠØ©: {product[3]}"
                # Generate QR code
                qr = qrcode.make(qr_data)
                
                # Save QR code to file
                filename = f"{product[1]}_{product[0]}.png"  # Product name and code as filename
                qr.save(filename)  # Save in the current directory
                
                QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø­ÙØ¸ QR ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ø³Ù… {filename}!")
                
                # Optionally, display the QR code in a dialog
                byte_array = io.BytesIO()
                qr.save(byte_array, format='PNG')
                byte_array.seek(0)
                qr_image = QImage()
                qr_image.loadFromData(byte_array.read())
                qr_pixmap = QPixmap(qr_image)
                
                qr_dialog = QDialog(self)
                qr_dialog.setWindowTitle("QR ÙƒÙˆØ¯")
                qr_layout = QVBoxLayout()
                
                qr_label = QLabel()
                qr_label.setPixmap(qr_pixmap)
                
                qr_layout.addWidget(qr_label)
                qr_dialog.setLayout(qr_layout)
                qr_dialog.exec_()
            else:
                QMessageBox.warning(self, "Ø®Ø·Ø£", "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")
